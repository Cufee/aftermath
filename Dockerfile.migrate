FROM golang:1.22.3-bookworm

WORKDIR /migrate

# copy migrations and schema
COPY ./internal/database/ent/migrate/migrations /migrations

RUN git clone https://github.com/Cufee/atlas-libsql.git
WORKDIR /migrate/atlas-libsql/cmd/atlas
RUN go mod download
RUN go generate ./...
RUN CGO_ENABLED=1 GOOS=linux go build -o /bin/atlas

ENTRYPOINT ["sh", "-c", 'atlas migrate apply --allow-dirty --dir "file:///migrations" --tx-mode all --url "libsql+ws://0.0.0.0:8080']
