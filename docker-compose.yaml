services:
  apply-migrations:
    image: aftermath-prisma-migrate
    build:
      dockerfile: Dockerfile.migrate
    environment:
      - DATABASE_URL=file:/database/${DATABASE_NAME}
    volumes:
      - ${DATABASE_DIR}:/database
    command: sh -c "go run github.com/steebchen/prisma-client-go migrate deploy --schema /prisma/schema.prisma"

  aftermath-service:
    image: aftermath-service
    build:
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - PORT=3000
      - DATABASE_URL=file:/database/${DATABASE_NAME}
    volumes:
      - ${DATABASE_DIR}:/database
    depends_on:
      apply-migrations:
        condition: service_completed_successfully
    entrypoint: ["app"]
    restart: always
    deploy:
      resources:
        reservations:
          memory: 128m
        limits:
          memory: 256m
    ports:
      - 3000
      - "${PRIVATE_SERVER_PORT}"
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.aftermath-monorepo-compose.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.aftermath-monorepo-compose.entrypoints=websecure"
      - "traefik.http.routers.aftermath-monorepo-compose.tls.certResolver=letsencrypt"
      - "traefik.http.services.aftermath-monorepo-compose.loadbalancer.server.port=3000"

networks:
  dokploy-network:
    external: true
