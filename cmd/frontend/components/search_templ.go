// Code generated by templ - DO NOT EDIT.

// templ: version: v0.2.747
package components

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

import (
	"github.com/cufee/aftermath/cmd/frontend/logic"
	"github.com/cufee/aftermath/internal/constants"
)

type PlayerSearch struct {
	RealmSelect    string
	SearchResults  string
	NicknameInput  string
	AccountIDInput string
}

func (p PlayerSearch) OnRealmSelect() templ.ComponentScript {
	return searchOnRealmSelect(p.SearchResults, p.RealmSelect, p.NicknameInput, p.AccountIDInput)
}
func (p PlayerSearch) OnNicknameInput() templ.ComponentScript {
	return searchOnNicknameInput(p.SearchResults, p.RealmSelect, p.NicknameInput, p.AccountIDInput)
}
func (p PlayerSearch) Scripts() templ.Component {
	return logic.EmbedMinifiedScript(searchEventHandler(p.SearchResults, p.NicknameInput, p.AccountIDInput, constants.WargamingPublicAppID), p.SearchResults, p.NicknameInput, p.AccountIDInput, constants.WargamingPublicAppID)
}

func (p PlayerSearch) RealmOptions(selected string) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString("<option disabled")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		if selected == "" {
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(" selected")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(">Select a Server</option> <option value=\"NA\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		if selected == "NA" {
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(" selected")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(">North America</option> <option value=\"EU\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		if selected == "EU" {
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(" selected")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(">Europe</option> <option value=\"AS\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		if selected == "AS" {
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(" selected")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(">Asia</option>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return templ_7745c5c3_Err
	})
}

func searchOnRealmSelect(searchResultsID, realmSelectID, nicknameInputID, accountIDInputID string) templ.ComponentScript {
	return templ.ComponentScript{
		Name: `__templ_searchOnRealmSelect_3536`,
		Function: `function __templ_searchOnRealmSelect_3536(searchResultsID, realmSelectID, nicknameInputID, accountIDInputID){const accountIdError = () => document.querySelector(accountIDInputID+"_error");
	const accountId = () => document.querySelector(accountIDInputID);
	const results = () => document.querySelector(searchResultsID);
	const select = () => document.querySelector(realmSelectID);
	const realm = () => select().value;
	// enable/disable field
	const nickname = () => document.querySelector(nicknameInputID);
	if (realm()) {
		if (nickname().value.length >= 5) {
			// if the input already exists - send a request
			results().innerHTML = '<li><span class="loading loading-dots loading-xs m-auto"></span></li>';
			const event = new CustomEvent("player-search", { detail: {query: nickname().value, realm: realm()} });
			document.dispatchEvent(event);
			return
		}
		nickname().disabled = false;
		accountIdError()?.classList.add("hidden")
	} else {
		nickname().disabled = true;
	}
	// clear results
	results().innerHTML = '<span class="text-xs text-center cursor-default">Start typing to search</span>';
}`,
		Call:       templ.SafeScript(`__templ_searchOnRealmSelect_3536`, searchResultsID, realmSelectID, nicknameInputID, accountIDInputID),
		CallInline: templ.SafeScriptInline(`__templ_searchOnRealmSelect_3536`, searchResultsID, realmSelectID, nicknameInputID, accountIDInputID),
	}
}

func searchOnNicknameInput(searchResultsID, realmSelectID, nicknameInputID, accountIDInputID string) templ.ComponentScript {
	return templ.ComponentScript{
		Name: `__templ_searchOnNicknameInput_76ea`,
		Function: `function __templ_searchOnNicknameInput_76ea(searchResultsID, realmSelectID, nicknameInputID, accountIDInputID){const accountIdError = () => document.querySelector(accountIDInputID+"_error");
	const nickname = () => document.querySelector(nicknameInputID);
	const results = () => document.querySelector(searchResultsID);
	const select = () => document.querySelector(realmSelectID);
	const realm = () => select().value;
	if (!realm()) {
		results().innerHTML = '<span class="text-xs text-center cursor-default">Start typing to search</span>';
		nickname().disabled = true;
		nickname().value = '';
		return;
	}
	if (!nickname().value) {
		results().innerHTML = '<span class="text-xs text-center cursor-default">Start typing to search</span>';
		return;
	}
	if (nickname().value.length < 5) {
		results().innerHTML = '<span class="text-xs text-center cursor-default">Continue typing to search</span>';
		return;
	}
	accountIdError()?.classList.add("hidden")
	const event = new CustomEvent("player-search", { detail: {query: nickname().value, realm: realm()} });
	document.dispatchEvent(event);
}`,
		Call:       templ.SafeScript(`__templ_searchOnNicknameInput_76ea`, searchResultsID, realmSelectID, nicknameInputID, accountIDInputID),
		CallInline: templ.SafeScriptInline(`__templ_searchOnNicknameInput_76ea`, searchResultsID, realmSelectID, nicknameInputID, accountIDInputID),
	}
}

func searchEventHandler(searchResultsID, nicknameInputID, accountIDInputID string, appId string) templ.ComponentScript {
	return templ.ComponentScript{
		Name: `__templ_searchEventHandler_b9c0`,
		Function: `function __templ_searchEventHandler_b9c0(searchResultsID, nicknameInputID, accountIDInputID, appId){const results = () => document.querySelector(searchResultsID);
	const nickname = () => document.querySelector(nicknameInputID);
	const accountId = () => document.querySelector(accountIDInputID);

	const setResultsLoading = () => {
		results().innerHTML = '<li><span class="loading loading-dots loading-xs m-auto"></span></li>';
	}

	const selectAccount = (name, id) => {
		nickname().value = name
		accountId().value = id
	}
	window.amthSelectAccount = selectAccount


	const getApiUrl = (realm, query) => {
		let baseUrl = "";
		switch (realm) {
			case "NA":
				baseUrl = "https://api.wotblitz.com/wotb";
				break;
			case "EU":
				baseUrl = "https://api.wotblitz.eu/wotb";
				break;
			case "AS":
				baseUrl = "https://api.wotblitz.asia/wotb";
				break;
			default:
				return "";
		}
		return baseUrl + "/account/list/" + "?application_id=" + appId + "&limit=5" + "&search=" + query;
	}

	let debounceTimeout;
	const debounceDelay = 500;

	document.addEventListener(
		"player-search",
		(evt) => {
			clearTimeout(debounceTimeout);
			debounceTimeout = setTimeout(() => {
				setResultsLoading()
				
				const { query, realm } = evt.detail;
				const url = getApiUrl(realm, query);
				if (!url) return;

				fetch(url).then(res => res.json()).then(data => {
					if (data.status != "ok") {
						results().innerHTML = ` + "`" + `<span class="text-xs text-center cursor-default">${data?.error?.message.toLocaleLowerCase().replaceAll("_", " ") || "Failed to get accounts"}</span>` + "`" + `;
						nickname().disabled = false;
						return;
					}
					const elements = []
					for (const account of data.data?.reverse() || []) {
						if (!account.account_id || !account.nickname) continue;
						elements.push(` + "`" + `<li><button onclick="window.amthSelectAccount('${account.nickname}','${account.account_id}');return false;">${account.nickname}</button></li>` + "`" + `);
					}
					if (elements.length == 0) {
						results().innerHTML = '<span class="text-xs text-center cursor-default">No players found</span>';
						nickname().disabled = false;
						return;
					}
					results().innerHTML = elements.join("");
					return;
				}).catch(e => {
					console.log("failed to search for accounts",e);
					results().innerHTML = '<span class="text-xs text-center cursor-default">No players found</span>';
					nickname().disabled = false;
				});
			}, debounceDelay);
		},
		false,
	);
}`,
		Call:       templ.SafeScript(`__templ_searchEventHandler_b9c0`, searchResultsID, nicknameInputID, accountIDInputID, appId),
		CallInline: templ.SafeScriptInline(`__templ_searchEventHandler_b9c0`, searchResultsID, nicknameInputID, accountIDInputID, appId),
	}
}
